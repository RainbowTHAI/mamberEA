<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EA Membership Admin Panel (Fixed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        input, select { @apply bg-slate-800 border border-slate-700 rounded p-2 outline-none focus:border-emerald-500 transition; color: white; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-8 glass p-6 rounded-2xl shadow-xl">
            <div>
                <h1 class="text-2xl font-bold text-emerald-400">EA License Manager</h1>
                <p class="text-slate-400 text-sm">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ú‡πà‡∏≤‡∏ô Supabase (Fixed Version)</p>
            </div>
            <div id="admin-info" class="hidden text-right text-sm">
                <p id="user-email" class="text-slate-300 font-mono mb-1"></p>
                <button onclick="logout()" class="text-red-400 hover:text-red-300 underline">Logout</button>
            </div>
        </header>

        <div id="login-section" class="max-w-md mx-auto glass p-8 rounded-2xl shadow-2xl mt-20">
            <h2 class="text-xl font-semibold mb-6 text-center italic text-emerald-300">Admin Login</h2>
            <div class="space-y-4">
                <input type="email" id="email" placeholder="Email" class="w-full">
                <input type="password" id="password" placeholder="Password" class="w-full">
                <button onclick="login()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-lg transition duration-200">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
            <p id="login-error" class="text-red-400 text-sm mt-4 text-center"></p>
        </div>

        <div id="dashboard-section" class="hidden space-y-8">
            <section class="glass p-6 rounded-2xl shadow-lg border-l-4 border-emerald-500">
                <h2 class="text-lg font-semibold mb-4 text-emerald-300 italic">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div class="flex flex-col">
                        <label class="text-xs mb-1 text-slate-400">Account Number</label>
                        <input type="text" id="new-account" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1234567">
                    </div>
                    <div class="flex flex-col">
                        <label class="text-xs mb-1 text-slate-400">Expiry Date</label>
                        <input type="date" id="new-expiry">
                    </div>
                    <div class="flex flex-col">
                        <label class="text-xs mb-1 text-slate-400">Account Type</label>
                        <select id="new-type">
                            <option value="REAL">REAL (Lock Port)</option>
                            <option value="DEMO">DEMO (Lock Time)</option>
                        </select>
                    </div>
                    <button onclick="addMember()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2.5 px-4 rounded transition duration-200">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
            </section>

            <section class="glass p-6 rounded-2xl shadow-lg">
                <h2 class="text-lg font-semibold mb-4 text-emerald-300 italic">üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="text-slate-400 border-b border-slate-700 text-sm">
                                <th class="py-3 px-4">Account</th>
                                <th class="py-3 px-4">Type</th>
                                <th class="py-3 px-4">Expiry</th>
                                <th class="py-3 px-4">Status</th>
                                <th class="py-3 px-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="member-list" class="text-sm"></tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://kzfssgwhbdbytfeqrqss.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt6ZnNzZ3doYmRieXRmZXFycXNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MTY0OTAsImV4cCI6MjA4NjQ5MjQ5MH0.De-n-HmXUc96T3OzcMSkKIVJG_jxHzk3yD2ZplauicA';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) updateUI(session);
            supabaseClient.auth.onAuthStateChange((_event, session) => updateUI(session));
        }

        function updateUI(session) {
            document.getElementById('login-section').classList.toggle('hidden', !!session);
            document.getElementById('dashboard-section').classList.toggle('hidden', !session);
            document.getElementById('admin-info').classList.toggle('hidden', !session);
            if (session) {
                document.getElementById('user-email').innerText = session.user.email;
                loadMembers();
            }
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) document.getElementById('login-error').innerText = error.message;
        }

        async function logout() { await supabaseClient.auth.signOut(); }

        async function loadMembers() {
            const { data, error } = await supabaseClient.from('members').select('*').order('created_at', { ascending: false });
            if (error) return console.error(error);
            const list = document.getElementById('member-list');
            list.innerHTML = data.map(m => `
                <tr class="border-b border-slate-800/50 hover:bg-slate-800/30">
                    <td class="py-4 px-4 font-mono font-bold">${m.account_number}</td>
                    <td class="py-4 px-4"><span class="px-2 py-1 rounded text-[10px] ${m.type === 'REAL' ? 'bg-amber-900 text-amber-400' : 'bg-slate-700'}">${m.type}</span></td>
                    <td class="py-4 px-4 font-mono">${m.expiry_date}</td>
                    <td class="py-4 px-4"><span class="px-2 py-1 rounded text-[10px] ${m.status === 'ACTIVE' ? 'bg-emerald-900 text-emerald-400' : 'bg-red-900 text-red-400'}">${m.status}</span></td>
                    <td class="py-4 px-4 text-right space-x-2">
                        <button onclick="toggleStatus('${m.account_number}', '${m.status}')" class="text-xs text-blue-400">‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
                        <button onclick="deleteMember('${m.account_number}')" class="text-xs text-red-400">‡∏•‡∏ö</button>
                    </td>
                </tr>
            `).join('');
        }

        async function addMember() {
            const account_number = document.getElementById('new-account').value.trim();
            const expiry_date = document.getElementById('new-expiry').value;
            const type = document.getElementById('new-type').value;
            if (!account_number || !expiry_date) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

            const { error } = await supabaseClient.from('members').insert([{ 
                account_number, 
                expiry_date, 
                type, 
                status: 'ACTIVE',
                created_at: new Date().toISOString() // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Error created_at ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏á
            }]);

            if (error) alert("Error: " + error.message);
            else { document.getElementById('new-account').value = ""; loadMembers(); }
        }

        async function toggleStatus(acc, status) {
            await supabaseClient.from('members').update({ status: status === 'ACTIVE' ? 'DISABLED' : 'ACTIVE' }).eq('account_number', acc);
            loadMembers();
        }

        async function deleteMember(acc) {
            if (confirm("‡∏•‡∏ö " + acc + "?")) {
                await supabaseClient.from('members').delete().eq('account_number', acc);
                loadMembers();
            }
        }
        checkAuth();
    </script>
</body>
</html>
